---
title: "DataWrangling"
author: "Nicole"
date: "2023-10-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
install.packages("plyr")
install.packages("lubridate")
library(lubridate)
library("plyr")
library("dplyr")
library(tidyverse)
library(tidyr)
library(zoo)

```

#Combining Datasets
```{r renaming data}
Total.WQ.Data <- rbind(CCM0069_1993_2003,CCM0069_2003_2013,CCM0069_2013_2023,EE3.0_1984_1993,EE3.0_1993_2003,EE3.0_2003_2013,EE3.0_2013_2023,EE3.1_1984_1993,EE3.1_1993_2003,EE3.1_2003_2013,EE3.1_2013_2023,ET6.1_1984_1993,ET6.1_1993_2003,ET6.1_2003_2013,ET6.1_2013_2023,ET6.2_1984_1993,ET6.2_1993_2003,ET6.2_2003_2013,ET6.2_2013_2023,ET7.1_1984_1993,ET7.1_1993_2003,ET7.1_2003_2013,ET7.1_2013_2023,WQ_1984_1990,WQ_1991_2001,WQ_2002_2012,WQ_2013_2023,TRQ0088_1993_2003,TRQ0088_2003_2013,TRQ0088_2013_2023,TRQ0146_1993_2003,TRQ0146_2003_2013,TRQ0146_2013_2023,WIW0141_1993_2003,WIW0141_2003_2013,WIW0141_2013_2023,XDJ9007_1993_2003,XDJ9007_2003_2013,XDJ9007_2013_2023)
```

#Making a dataset for TN, TP, TSS
```{r}
TN.TP.TSS.Data <- filter(Total.WQ.Data, Parameter == "TN" | Parameter == "TP" | Parameter == "TSS") 
TN.TP.TSS.Data$SampleDate<- as.Date(TN.TP.TSS.Data$SampleDate, format="%m/%d/%Y")
TN.TP.TSS.Data.Processed <- TN.TP.TSS.Data %>%
  select(MonitoringStation, SampleDate, SampleTime, Parameter, MeasureValue, Unit, Latitude, Longitude)

##remove unit column (they're all MG/L)
TN.TP.TSS.Data.Processed <- TN.TP.TSS.Data.Processed %>%
  select(MonitoringStation, SampleDate, SampleTime, Parameter, MeasureValue, Latitude, Longitude)

##pivot wider
TN.TP.TSS.Data.Final <- TN.TP.TSS.Data.Processed %>%
  pivot_wider(names_from = Parameter, 
    values_from = MeasureValue,
    values_fn = mean) 

View(TN.TP.TSS.Data.Final)
class(TN.TP.TSS.Data.Final)

# write.csv(TN.TP.TSS.Data.Processed, row.names = FALSE, file = "~/Master's Project/Data/Processed/TN_TP_TSS_Data_Processed.csv")

write.csv(TN.TP.TSS.Data.Final, row.names = FALSE, file = "../Data/Processed/TN_TP_TSS_Data_Final.csv")
```

```{r}
TN.TP.TSS.Data.Final <- read.csv("../Data/Processed/TN_TP_TSS_Data_Final.csv")

##making year, month, and day columns
TN.TP.TSS.Data.Final <- TN.TP.TSS.Data.Final %>% 
  separate(SampleDate, c("year", "month", "day"))

##fixing short year format
TN.TP.TSS.Data.Final$year[TN.TP.TSS.Data.Final$year=="13"] <- "2013"
TN.TP.TSS.Data.Final$year[TN.TP.TSS.Data.Final$year=="14"] <- "2014"
TN.TP.TSS.Data.Final$year[TN.TP.TSS.Data.Final$year=="15"] <- "2015"
TN.TP.TSS.Data.Final$year[TN.TP.TSS.Data.Final$year=="16"] <- "2016"
TN.TP.TSS.Data.Final$year[TN.TP.TSS.Data.Final$year=="17"] <- "2017"
TN.TP.TSS.Data.Final$year[TN.TP.TSS.Data.Final$year=="18"] <- "2018"
TN.TP.TSS.Data.Final$year[TN.TP.TSS.Data.Final$year=="19"] <- "2019"
TN.TP.TSS.Data.Final$year[TN.TP.TSS.Data.Final$year=="20"] <- "2020"
TN.TP.TSS.Data.Final$year[TN.TP.TSS.Data.Final$year=="21"] <- "2021"
TN.TP.TSS.Data.Final$year[TN.TP.TSS.Data.Final$year=="22"] <- "2022"

##recombining date column
TN.TP.TSS.Data.Final$SampleDate <- paste(TN.TP.TSS.Data.Final$year, TN.TP.TSS.Data.Final$month, TN.TP.TSS.Data.Final$day, sep='-')

TN.TP.TSS.Data.Final <- TN.TP.TSS.Data.Final %>%
  relocate(SampleDate, .after=day)

##converting to date
TN.TP.TSS.Data.Final$SampleDate <- as.Date(TN.TP.TSS.Data.Final$SampleDate, format="%Y-%m-%d")

##creating month_year column
TN.TP.TSS.Data.Final <- TN.TP.TSS.Data.Final %>%
  mutate(year_month = as.yearmon(SampleDate))

TN.TP.TSS.Data.Final <- TN.TP.TSS.Data.Final %>%
  relocate(year_month, .after=SampleDate)

##grouping by site and year_month
TN.TP.TSS.Data.Final <- TN.TP.TSS.Data.Final %>%
  group_by(MonitoringStation, Latitude, Longitude, year_month) %>%
  summarize(meanTN = mean(TN),
            meanTP = mean(TP),
            meanTSS = mean(TSS))

##change yearmon object to date object
TN.TP.TSS.Data.Final$year_month <- as.Date(TN.TP.TSS.Data.Final$year_month, format = "%Y-%m-%d")
class(TN.TP.TSS.Data.Final$year_month)

```

## Separate by station for time series
```{r}
BXK0031_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "BXK0031")
CCM0069_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "CCM0069")
EE3.0_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "EE3.0")
EE3.1_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "EE3.1")
EE3.2_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "EE3.2")
EE3.3_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "EE3.3")
ET6.1_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "ET6.1")
ET6.2_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "ET6.2")
ET7.1_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "ET7.1")
ET8.1_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "ET8.1")
ET9.1_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "ET9.1")
ET10.1_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "ET10.1")
MNK0146_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "MNK0146")
POK0087_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "POK0087")
TRQ0088_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "TRQ0088")
TRQ0146_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "TRQ0146")
WIW0141_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "WIW0141")
WIW0144_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "WIW0144")
XAK7810_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "XAK7810")
XCI4078_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "XCI4078")
XDJ9007_TN_TP_TSS <- filter(TN.TP.TSS.Data.Final, MonitoringStation == "XDJ9007")
```

## Exploratory Analysis 
## (note: changed SampleDate to year_month and TN to meanTN)
```{r}
list.dfs <- list(BXK0031_TN_TP_TSS,CCM0069_TN_TP_TSS,EE3.0_TN_TP_TSS,EE3.1_TN_TP_TSS,EE3.2_TN_TP_TSS,EE3.3_TN_TP_TSS,ET6.1_TN_TP_TSS,ET6.2_TN_TP_TSS,ET7.1_TN_TP_TSS,ET8.1_TN_TP_TSS,ET9.1_TN_TP_TSS,ET10.1_TN_TP_TSS,MNK0146_TN_TP_TSS,POK0087_TN_TP_TSS,TRQ0088_TN_TP_TSS,TRQ0146_TN_TP_TSS,WIW0141_TN_TP_TSS,XAK7810_TN_TP_TSS,XCI4078_TN_TP_TSS,XDJ9007_TN_TP_TSS)

# Representing trends in TN over time at each site
plot.chrs <- function(list.dfs) { 
  plot.list <- vector(mode = 'list', length = length(list.dfs))
  
  for (i in 1:length(list.dfs)) {
    plot.list[[i]] <- ggplot(list.dfs[[i]], aes(x=year_month, y=meanTN)) +
                      geom_line() +
                      ggtitle(list.dfs[[i]]$MonitoringStation)
    names(plot.list)[i] <- paste0(list.dfs[[i]]$MonitoringStation)
  }
  return(plot.list)
}
plot.chrs(list.dfs)

```

## Removing data gaps
```{r}
# BXK0031_TN_TP_TSS.Early <- BXK0031_TN_TP_TSS %>%
#   filter(SampleDate < as.Date("2013-12-31"))

##change formatting
BXK0031_TN_TP_TSS.Complete <- BXK0031_TN_TP_TSS %>%
  filter(year_month <= as.Date("2013-12-01"))
##ordering dataframe
  BXK0031_TN_TP_TSS.Complete <- BXK0031_TN_TP_TSS.Complete[order(BXK0031_TN_TP_TSS.Complete$year_month),]
##remove NA rows
BXK0031_TN_TP_TSS.Complete <- BXK0031_TN_TP_TSS.Complete[!is.na(BXK0031_TN_TP_TSS.Complete$MonitoringStation),]
# Missing first 2 months (Jan, Feb)

CCM0069_TN_TP_TSS.Complete <- CCM0069_TN_TP_TSS %>%
  filter(year_month <= as.Date("2013-12-01"))
CCM0069_TN_TP_TSS.Complete <- CCM0069_TN_TP_TSS.Complete[order(CCM0069_TN_TP_TSS.Complete$year_month),]
CCM0069_TN_TP_TSS.Complete <- CCM0069_TN_TP_TSS.Complete[!is.na(CCM0069_TN_TP_TSS.Complete$MonitoringStation),]
  nrow(CCM0069_TN_TP_TSS.Complete)
# Missing first 2 months (Jan, Feb)
  
EE3.0_TN_TP_TSS.Complete <- EE3.0_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-12-01"))
EE3.0_TN_TP_TSS.Complete <- EE3.0_TN_TP_TSS.Complete[order(EE3.0_TN_TP_TSS.Complete$year_month),]
EE3.0_TN_TP_TSS.Complete <- EE3.0_TN_TP_TSS.Complete[!is.na(EE3.0_TN_TP_TSS.Complete$MonitoringStation),]
## Missing 23 months

EE3.1_TN_TP_TSS.Complete <- EE3.1_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-12-01"))
EE3.1_TN_TP_TSS.Complete <- EE3.1_TN_TP_TSS.Complete[order(EE3.1_TN_TP_TSS.Complete$year_month),]
EE3.1_TN_TP_TSS.Complete <- EE3.1_TN_TP_TSS.Complete[!is.na(EE3.1_TN_TP_TSS.Complete$MonitoringStation),]
#Missing 20 months

EE3.2_TN_TP_TSS.Complete <- EE3.2_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-12-01"))
EE3.2_TN_TP_TSS.Complete <- EE3.2_TN_TP_TSS.Complete[order(EE3.2_TN_TP_TSS.Complete$year_month),]
EE3.2_TN_TP_TSS.Complete <- EE3.2_TN_TP_TSS.Complete[!is.na(EE3.2_TN_TP_TSS.Complete$MonitoringStation),]
#Missing 35 months

EE3.3_TN_TP_TSS.Complete <- EE3.3_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-12-01"))
EE3.3_TN_TP_TSS.Complete <- EE3.3_TN_TP_TSS.Complete[order(EE3.3_TN_TP_TSS.Complete$year_month),]
EE3.3_TN_TP_TSS.Complete <- EE3.3_TN_TP_TSS.Complete[!is.na(EE3.3_TN_TP_TSS.Complete$MonitoringStation),]
#Missing 73 months

ET6.1_TN_TP_TSS.Complete <- ET6.1_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-12-01"))
ET6.1_TN_TP_TSS.Complete <- ET6.1_TN_TP_TSS.Complete[order(ET6.1_TN_TP_TSS.Complete$year_month),]
ET6.1_TN_TP_TSS.Complete <- ET6.1_TN_TP_TSS.Complete[!is.na(ET6.1_TN_TP_TSS.Complete$MonitoringStation),]
#Missing 4 months

ET6.2_TN_TP_TSS.Complete <- ET6.2_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-12-01"))
ET6.2_TN_TP_TSS.Complete <- ET6.2_TN_TP_TSS.Complete[order(ET6.2_TN_TP_TSS.Complete$year_month),]
ET6.2_TN_TP_TSS.Complete <- ET6.2_TN_TP_TSS.Complete[!is.na(ET6.2_TN_TP_TSS.Complete$MonitoringStation),]
#Missing 24 months

ET7.1_TN_TP_TSS.Complete <- ET7.1_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-12-01"))
ET7.1_TN_TP_TSS.Complete <- ET7.1_TN_TP_TSS.Complete[order(ET7.1_TN_TP_TSS.Complete$year_month),]
ET7.1_TN_TP_TSS.Complete <- ET7.1_TN_TP_TSS.Complete[!is.na(ET7.1_TN_TP_TSS.Complete$MonitoringStation),]
#Missing 12 months

ET8.1_TN_TP_TSS.Complete <- ET8.1_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-12-01"))
ET8.1_TN_TP_TSS.Complete <- ET8.1_TN_TP_TSS.Complete[order(ET8.1_TN_TP_TSS.Complete$year_month),]
ET8.1_TN_TP_TSS.Complete <- ET8.1_TN_TP_TSS.Complete[!is.na(ET8.1_TN_TP_TSS.Complete$MonitoringStation),]
#Missing 24 months

ET9.1_TN_TP_TSS.Complete <- ET9.1_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-12-01"))
ET9.1_TN_TP_TSS.Complete <- ET9.1_TN_TP_TSS.Complete[order(ET9.1_TN_TP_TSS.Complete$year_month),]
ET9.1_TN_TP_TSS.Complete <- ET9.1_TN_TP_TSS.Complete[!is.na(ET9.1_TN_TP_TSS.Complete$MonitoringStation),]
#Missing 18 months

ET10.1_TN_TP_TSS.Complete <- ET10.1_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-12-01"))
ET10.1_TN_TP_TSS.Complete <- ET10.1_TN_TP_TSS.Complete[order(ET10.1_TN_TP_TSS.Complete$year_month),]
ET10.1_TN_TP_TSS.Complete <- ET10.1_TN_TP_TSS.Complete[!is.na(ET10.1_TN_TP_TSS.Complete$MonitoringStation),]
#Missing 7 months

MNK0146_TN_TP_TSS.Complete <- MNK0146_TN_TP_TSS %>%
  filter(year_month <= as.Date("2013-12-01"))
MNK0146_TN_TP_TSS.Complete <- MNK0146_TN_TP_TSS.Complete[order(MNK0146_TN_TP_TSS.Complete$year_month),]
MNK0146_TN_TP_TSS.Complete <- MNK0146_TN_TP_TSS.Complete[!is.na(MNK0146_TN_TP_TSS.Complete$MonitoringStation),]
#Missing 33 months

POK0087_TN_TP_TSS.Complete <- POK0087_TN_TP_TSS %>%
  filter(year_month <= as.Date("2014-10-01"))
POK0087_TN_TP_TSS.Complete <- POK0087_TN_TP_TSS.Complete[order(POK0087_TN_TP_TSS.Complete$year_month),]
POK0087_TN_TP_TSS.Complete <- POK0087_TN_TP_TSS.Complete[!is.na(POK0087_TN_TP_TSS.Complete$MonitoringStation),]
# Missing 7 months
### most stop after 2013-3 for TN, TP

TRQ0088_TN_TP_TSS.Complete <- TRQ0088_TN_TP_TSS %>%
  filter(year_month <= as.Date("2013-12-01"))
TRQ0088_TN_TP_TSS.Complete <- TRQ0088_TN_TP_TSS.Complete[order(TRQ0088_TN_TP_TSS.Complete$year_month),]
TRQ0088_TN_TP_TSS.Complete <- TRQ0088_TN_TP_TSS.Complete[!is.na(TRQ0088_TN_TP_TSS.Complete$MonitoringStation),]
# Missing 2 months

TRQ0146_TN_TP_TSS.Complete <- TRQ0146_TN_TP_TSS %>%
  filter(year_month <= as.Date("2013-12-01"))
TRQ0146_TN_TP_TSS.Complete <- TRQ0146_TN_TP_TSS.Complete[order(TRQ0146_TN_TP_TSS.Complete$year_month),]
TRQ0146_TN_TP_TSS.Complete <- TRQ0146_TN_TP_TSS.Complete[!is.na(TRQ0146_TN_TP_TSS.Complete$MonitoringStation),]
# Missing 2 Months

WIW0141_TN_TP_TSS.Complete <- WIW0141_TN_TP_TSS %>%
  filter(year_month <= as.Date("2022-11-01"))
WIW0141_TN_TP_TSS.Complete <- WIW0141_TN_TP_TSS.Complete[order(WIW0141_TN_TP_TSS.Complete$year_month),]
WIW0141_TN_TP_TSS.Complete <- WIW0141_TN_TP_TSS.Complete[!is.na(WIW0141_TN_TP_TSS.Complete$MonitoringStation),]
# Missing 15 months

XAK7810_TN_TP_TSS.Complete <- XAK7810_TN_TP_TSS %>%
 filter(year_month <= as.Date("2014-10-01"))
XAK7810_TN_TP_TSS.Complete <- XAK7810_TN_TP_TSS.Complete[order(XAK7810_TN_TP_TSS.Complete$year_month),]
XAK7810_TN_TP_TSS.Complete <- XAK7810_TN_TP_TSS.Complete[!is.na(XAK7810_TN_TP_TSS.Complete$MonitoringStation),]
# Missing 27 months

XCI4078_TN_TP_TSS.Complete <- XCI4078_TN_TP_TSS %>%
  filter(year_month <= as.Date("2013-12-01"))
XCI4078_TN_TP_TSS.Complete <- XCI4078_TN_TP_TSS.Complete[order(XCI4078_TN_TP_TSS.Complete$year_month),]
XCI4078_TN_TP_TSS.Complete <- XCI4078_TN_TP_TSS.Complete[!is.na(XCI4078_TN_TP_TSS.Complete$MonitoringStation),]
# Missing 6 months

XDJ9007_TN_TP_TSS.Complete <- XDJ9007_TN_TP_TSS %>%
  filter(year_month <= as.Date("2013-12-01"))
XDJ9007_TN_TP_TSS.Complete <- XDJ9007_TN_TP_TSS.Complete[order(XDJ9007_TN_TP_TSS.Complete$year_month),]
XDJ9007_TN_TP_TSS.Complete <- XDJ9007_TN_TP_TSS.Complete[!is.na(XDJ9007_TN_TP_TSS.Complete$MonitoringStation),]
# Missing first 2 months (Jan, Feb)
```
